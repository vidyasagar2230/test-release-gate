name: Quality-Gate
on: [pull_request]

jobs:
  # JOB 1: Automatic Verification
  verify-flow:
    # This runs for SYS and UAT, but skips for INT so you can actually start the process
    runs-on: ubuntu-latest
    steps:
      - name: Check Status
        uses: actions/github-script@v6
        with:
          script: |
            const target = context.payload.pull_request.base.ref;
            
            // 1. If merging to INT or main, we don't need to check a previous environment
            if (target === 'INT' || target === 'main') {
              console.log("Target is " + target + ". Skipping previous environment check.");
              return; 
            }
            
            // 2. Determine what status we are looking for
            const requiredContext = target === 'SYS' ? 'int-test' : 'sys-test';
            
            const { data: statuses } = await github.rest.repos.getCombinedStatusForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha
            });

            const success = statuses.statuses.find(s => s.context === requiredContext && s.state === 'success');
            
            if (!success) {
              core.setFailed(`STOP! This code has not passed ${requiredContext} yet. You must merge to the previous environment first.`);
            } else {
              console.log(`Success: Found passing status for ${requiredContext}`);
            }

  # JOB 2: The Manual Approval Button (Only triggers for UAT)
  manual-lead-signoff:
    needs: verify-flow
    # Only run the approval button if the PR is targeting UAT
    if: github.base_ref == 'UAT'
    runs-on: ubuntu-latest
    environment: UAT-Approval
    steps:
      - name: Awaiting Approval
        run: echo "Lead has approved the merge to UAT."
