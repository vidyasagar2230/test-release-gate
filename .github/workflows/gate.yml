name: Quality-Gate
on: [pull_request]

jobs:
  # JOB 1: Automatic Verification
  verify-flow:
    runs-on: ubuntu-latest
    steps:
      - name: Check Status
        uses: actions/github-script@v6
        with:
          script: |
            const target = context.payload.pull_request.base.ref;
            
            // 1. Skip check for INT or main
            if (target === 'INT' || target === 'main') {
              console.log("Target is " + target + ". Skipping previous environment check.");
              return; 
            }
            
            // 2. Determine previous environment name
            const prevEnv = target === 'SYS' ? 'INT' : 'SYS';
            
            // 3. Search for a CLOSED and MERGED Pull Request from this branch into the previous environment
            // This is more reliable than SHA checking when multiple merges occur.
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              head: `${context.repo.owner}:${context.payload.pull_request.head.ref}`,
              base: prevEnv
            });

            const isMerged = pulls.find(p => p.merged_at !== null);
            
            if (!isMerged) {
              core.setFailed(`STOP! You must successfully MERGE this branch into ${prevEnv} before you can merge into ${target}.`);
            } else {
              console.log(`Success! Branch was previously merged into ${prevEnv}. Access granted to ${target}.`);
            }
            
  # JOB 2: The Manual Approval Button (Only triggers for UAT)
  manual-lead-signoff:
    needs: verify-flow
    if: github.base_ref == 'UAT'
    runs-on: ubuntu-latest
    environment: UAT-Approval
    steps:
      - name: Awaiting Approval
        run: echo "Lead has approved the merge to UAT."
