name: Quality-Gate
on: [pull_request]

jobs:
  # JOB 1: Automatic Verification
  verify-flow:
    runs-on: ubuntu-latest
    steps:
      - name: Check Status
        uses: actions/github-script@v6
        with:
          script: |
            const target = context.payload.pull_request.base.ref;
            
            // 1. Skip check for INT or main
            if (target === 'INT' || target === 'main') {
              console.log("Target is " + target + ". Skipping previous environment check.");
              return; 
            }
            
            // 2. Determine what status we are looking for
            const requiredContext = target === 'SYS' ? 'int-test' : 'sys-test';
            
            // 3. Look through the commit statuses for the PR head
            const { data: statuses } = await github.rest.repos.listCommitStatusesForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha
            });

            // 4. Check if ANY commit in this branch history has the required 'success'
            const success = statuses.find(s => s.context === requiredContext && s.state === 'success');
            
            if (!success) {
              core.setFailed(`STOP! No record of a successful ${requiredContext} was found. You must merge to the previous environment and pass tests first.`);
            } else {
              console.log(`Success: Found passing status for ${requiredContext}`);
            }

  # JOB 2: The Manual Approval Button (Only triggers for UAT)
  manual-lead-signoff:
    needs: verify-flow
    if: github.base_ref == 'UAT'
    runs-on: ubuntu-latest
    environment: UAT-Approval
    steps:
      - name: Awaiting Approval
        run: echo "Lead has approved the merge to UAT."
